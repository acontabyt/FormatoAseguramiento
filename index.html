<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título Actualizado -->
    <title>Informe de Aseguramiento (con Login)</title>
    <!-- 
      Usamos Tailwind CSS para un diseño moderno y responsivo.
      También incluimos las librerías para generar el PDF (jsPDF y jsPDF-AutoTable).
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Importar Fuente Estilizada (Dancing Script) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <!-- NUEVO: Mover showMessage aquí para que esté disponible globalmente -->
    <script>
        // Función para mostrar mensajes (MOVIDA ARRIBA)
        function showMessage(message, type = 'success') {
            const container = document.getElementById('message-container');
            if (!container) {
                console.warn("Contenedor de mensajes no encontrado.", message);
                return; 
            }
            const msgDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            msgDiv.className = `p-4 ${bgColor} text-white rounded-lg shadow-lg mb-2 transition-all duration-300 ease-out transform translate-x-full`;
            msgDiv.textContent = message;
            
            container.appendChild(msgDiv);

            // Animar entrada
            setTimeout(() => {
                msgDiv.classList.remove('translate-x-full');
                msgDiv.classList.add('translate-x-0');
            }, 10);

            // Ocultar después de 3 segundos
            setTimeout(() => {
                msgDiv.classList.add('opacity-0');
                msgDiv.classList.add('translate-x-full');
                setTimeout(() => {
                    if (container && container.contains(msgDiv)) {
                        container.removeChild(msgDiv);
                    }
                }, 500);
            }, 3000);
        }
    </script>

    <style>
        /* Estilos adicionales para un mejor aspecto */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Clase para la nueva fuente del título */
        .font-dancing-script {
            font-family: 'Dancing Script', cursive;
        }

        /* Estilo para los inputs de número sin flechas */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Estilo para los selects */
        select {
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.65em auto;
            padding-right: 2.5rem;
        }
        /* Ocultar botones de gestión por defecto */
        .gestion-btn {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- Contenedor para mensajes de éxito/error (en lugar de alert) -->
    <div id="message-container" class="fixed top-5 right-5 z-50"></div>
    
    <!-- (NUEVO) Pantalla de Carga -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <!-- Icono de "Cargando" (Spinner) -->
            <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-white text-lg font-medium">Cargando...</p>
        </div>
    </div>
    
    <!-- (NUEVO) Contenedor de Autenticación -->
    <div id="auth-container" class="container max-w-md mx-auto bg-white shadow-xl rounded-lg overflow-hidden p-8 hidden">
        <h2 class="text-2xl font-bold text-center text-purple-700 mb-6 font-dancing-script">Iniciar Sesión o Registrarse</h2>
        
        <div class="space-y-4">
            <div>
                <label for="loginEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                <input type="email" id="loginEmail" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
            </div>
            <div>
                <label for="loginPassword" class="block text-sm font-medium text-gray-700">Contraseña</label>
                <input type="password" id="loginPassword" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
            </div>
            
            <p id="authMessage" class="text-sm text-red-600 text-center"></p>

            <div class="flex flex-col md:flex-row gap-4">
                <button id="loginBtn" class="flex-1 py-2 px-4 bg-purple-700 text-white font-semibold rounded-full shadow-md hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95">
                    Iniciar Sesión
                </button>
                <button id="registerBtn" class="flex-1 py-2 px-4 bg-yellow-200 text-yellow-800 font-semibold rounded-full shadow-md hover:bg-yellow-300 focus:outline-none focus:ring-2 focus:ring-yellow-300 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95">
                    Registrarse
                </button>
            </div>
        </div>
    </div>

    <!-- (NUEVO) Contenedor Principal de la Aplicación (Oculto por defecto) -->
    <div id="app-container" class="container max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden hidden">
        <!-- Encabezado -->
        <div class="bg-purple-700 p-6 flex justify-between items-center">
            <!-- Título Actualizado con Icono, Fuente y Tamaño -->
            <h1 class="text-3xl md:text-4xl font-bold text-white flex items-center font-dancing-script">
                <!-- Icono de "Aseguramiento" (Escudo) - Tamaño Aumentado -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Informe de Aseguramiento
            </h1>
            <div class="text-right">
                <p class="text-sm text-purple-200" id="userEmailDisplay"></p>
                <button id="logoutBtn" class="text-sm text-yellow-200 hover:text-yellow-100 font-semibold">Cerrar Sesión</button>
            </div>
        </div>

        <!-- (NUEVA UBICACIÓN) Botón Limpiar Formulario -->
        <div class="p-6 md:p-8 pb-0 flex justify-end">
            <button type="button" id="clearFormBtn"> <!-- La clase se aplica por JS -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15m0 0l6.75-6.75M4.5 12l6.75 6.75" />
                </svg>
                Limpiar Formulario
            </button>
        </div>

        <!-- Formulario -->
        <form id="report-form" class="p-6 md:p-8 pt-6 space-y-6"> <!-- Padding superior ajustado -->

            <!-- Sección Contador -->
            <div class="form-group">
                <label for="selectContador" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectContador" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Contador --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <!-- Icono "Datos del Contador" (Tarjeta de Identificación) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    Datos del Contador
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="contadorNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Contador</label>
                        <input type="text" id="contadorNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="contadorRif" class="block text-sm font-medium text-gray-700 mb-1">RIF del Contador</label>
                        <input type="text" id="contadorRif" placeholder="Ej: V-12345678-9" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="form-group">
                        <label for="contadorCpc" class="block text-sm font-medium text-gray-700 mb-1">Núm. C.P.C.</label>
                        <input type="text" id="contadorCpc" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>

                <!-- Nuevo Campo: Sello del Contador -->
                <div class="form-group mt-4">
                    <label for="contadorSello" class="block text-sm font-medium text-gray-700 mb-1">Sello del Contador (Opcional)</label>
                    <input type="file" id="contadorSello" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100" accept="image/png">
                    <!-- Texto de ayuda actualizado para reflejar el nuevo tamaño -->
                    <small class="text-xs text-gray-500">Subir PNG. Máx: 5.30cm (ancho) x 2.10cm (alto).</small>
                    
                    <img id="selloPreview" src="" alt="Vista previa del sello" class="mt-2 h-16 object-contain hidden" />
                </div>
                
                <div class="text-right mt-4 space-x-2">
                    <!-- Botones solo ícono -->
                    <button type="button" id="deleteContadorBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateContadorBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveContadorBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Cliente -->
             <div class="form-group">
                <label for="selectCliente" class="block text-sm font-medium text-gray-700 mb-1"></label>
                <select id="selectCliente" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50">
                    <option value="">-- Selecciona Cliente --</option>
                </select>
            </div>
            <fieldset class="border border-gray-200 p-4 rounded-md">
                <legend class="text-lg font-semibold text-purple-800 mb-4 px-2 flex items-center">
                    <!-- Icono "Datos del Cliente" (Usuario) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Datos del Cliente
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label for="clienteTratamiento" class="block text-sm font-medium text-gray-700 mb-1">Tratamiento</label>
                        <select id="clienteTratamiento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                            <option value="Sr.">Sr.</option>
                            <option value="Sra.">Sra.</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="clienteNombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                        <input type="text" id="clienteNombre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="clienteCedula" class="block text-sm font-medium text-gray-700 mb-1">N.º de Cédula</label>
                        <input type="text" id="clienteCedula" placeholder="Ej: V-12345678" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
                 <div class="text-right mt-4 space-x-2">
                    <!-- Botones solo ícono -->
                    <button type="button" id="deleteClienteBtn" class="btn-danger gestion-btn" title="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="updateClienteBtn" class="btn-warning gestion-btn" title="Actualizar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button type="button" id="saveClienteBtn" class="btn-save" title="Guardar como Nuevo">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                    </button>
                </div>
            </fieldset>

            <!-- Sección Informe -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <!-- Icono "Datos del Informe" (Documento) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Datos del Informe
                </legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="entidadDirigida" class="block text-sm font-medium text-gray-700 mb-1">Entidad a la que se dirige</label>
                        <!-- Input modificado para incluir la lista -->
                        <input type="text" id="entidadDirigida" list="bancos-list" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <!-- Nueva Datalist de Bancos -->
                        <datalist id="bancos-list">
                            <option value="Banco de Venezuela, S.A. Banco Universal"></option>
                            <option value="Banesco Banco Universal, C.A."></option>
                            <option value="Banco Provincial, S.A. Banco Universal"></option>
                            <option value="Banco Mercantil, C.A. Banco Universal"></option>
                            <option value="Bancaribe, C.A. Banco Universal"></option>
                            <option value="Banco Nacional de Crédito, C.A. Banco Universal"></option>
                            <option value="Banco Exterior, C.A. Banco Universal"></option>
                            <option value="Banco del Tesoro, C.A. Banco Universal"></option>
                            <option value="Bicentenario Banco Universal, C.A."></option>
                            <option value="100% Banco, Banco Universal"></option>
                            <option value="Banplus Banco Universal, C.A."></option>
                            <option value="Banca Amiga, C.A. Banco Universal"></option>
                            <option value="Mi Banco, C.A. Banco de Desarrollo"></option>
                            <option value="Banco Venezolano de Crédito, S.A. Banco Universal"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="motivoInforme" class="block text-sm font-medium text-gray-700 mb-1">Motivo del Informe</label>
                        <input type="text" id="motivoInforme" list="motivos-list" placeholder="Ej: Solicitud de crédito" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="motivos-list">
                            <option value="Solicitud de crédito"></option>
                            <option value="Apertura de la Cuenta Bancaria"></option>
                            <option value="Actualización de datos"></option>
                            <option value="Trámite de visa"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="lugar" class="block text-sm font-medium text-gray-700 mb-1">Lugar</label>
                        <input type="text" id="lugar" list="ciudades-list" placeholder="Ej: Barquisimeto" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                        <datalist id="ciudades-list">
                            <option value="Caracas"></option>
                            <option value="Maracaibo"></option>
                            <option value="Valencia"></option>
                            <option value="Barquisimeto"></option>
                            <option value="Maracay"></option>
                            <option value-"Ciudad Guayana"></option>
                            <option value="San Cristóbal"></option>
                            <option value="Mérida"></option>
                            <option value="Barcelona"></option>
                            <option value="Cumaná"></option>
                            <option value="Maturín"></option>
                            <option value="Porlamar"></option>
                            <option value="Barinas"></option>
                            <option value="Coro"></option>
                            <option value="San Felipe"></option>
                            <option value="San Juan de los Morros"></option>
                            <option value="Quibor"></option>
                            <option value="El Tocuyo"></option>
                            <option value="Sanare"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="fechaDocumento" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Documento</label>
                        <input type="date" id="fechaDocumento" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaDesde" class="block text-sm font-medium text-gray-700 mb-1">Período - Desde</label>
                        <input type="date" id="fechaDesde" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                    <div class="form-group">
                        <label for="fechaHasta" class="block text-sm font-medium text-gray-700 mb-1">Período - Hasta</label>
                        <input type="date" id="fechaHasta" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                    </div>
                </div>
            </fieldset>

            <!-- Sección Ingresos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <!-- Icono "Detalle de Ingresos" (Colección/Lista) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Detalle de los Ingresos del Período
                </legend>
                
                <!-- Datalist para conceptos (se llenará dinámicamente) -->
                <datalist id="conceptos-list"></datalist>

                <div id="income-details" class="space-y-3 mb-4">
                    <!-- Los ingresos se agregarán aquí dinámicamente -->
                </div>
                <button type="button" class="btn-secondary" onclick="addIncomeItem()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Agregar Concepto
                </button>
            </fieldset>

            <!-- Sección Gestionar Conceptos -->
            <fieldset class="border-t border-gray-200 pt-6">
                <legend class="text-lg font-semibold text-purple-800 mb-4 flex items-center">
                    <!-- Icono "Gestionar Conceptos" (Engranaje) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Gestionar Conceptos de Ingreso
                </legend>
                <div class="space-y-4">
                    <div>
                        <label for="conceptosSelect" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <select id="conceptosSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 bg-gray-50"></select>
                    </div>
                    <div>
                        <label for="conceptoEditInput" class="block text-sm font-medium text-gray-700 mb-1">Concepto (para agregar o editar)</label>
                        <input type="text" id="conceptoEditInput" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <!-- Botones solo ícono -->
                        <button type="button" id="conceptoBtnAgregar" class="btn-save" title="Agregar Nuevo">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEditar" class="btn-warning" title="Cargar para Editar">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnGuardarEdicion" class="btn-save" style="display:none;" title="Guardar Cambios">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" /></svg>
                        </button>
                        <button type="button" id="conceptoBtnEliminar" class="btn-danger" title="Eliminar Seleccionado">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </fieldset>


            <!-- Botones de Acción (Modificado) -->
            <div class="pt-6 border-t border-gray-200 flex justify-center">
                <!-- Botón Limpiar movido a la parte superior -->
                 <button type="submit" class="btn-primary w-full md:w-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Generar PDF
                </button>
            </div>
        </form>
    </div>


    <!-- Firebase SDKs (NUEVO) -->
    <script type="module">
        // Importar funciones de Firebase (NUEVO)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            writeBatch,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase (debe ser proporcionada por el entorno) ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let app;
        let auth;
        let db;
        let currentUserId = null;
        
        // --- Referencias a Colecciones (Globales) ---
        let contadoresUnsubscribe = () => {};
        let clientesUnsubscribe = () => {};
        let conceptosUnsubscribe = () => {};

        // --- IDs de Elementos DOM (Movidos arriba para el Catch) ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const authMessage = document.getElementById('authMessage');

        try {
            // Si la configuración está vacía, lanzar un error
            if (!firebaseConfig.apiKey) {
                throw new Error("Configuración de Firebase no proporcionada. Siga los pasos de 'firebase_setup.md'.");
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('Debug'); // Habilitar logs de Firestore
            
            // --- Lógica de Autenticación (MOVIDA DENTRO DEL TRY) ---
            
            // IDs de elementos restantes
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userEmailDisplay = document.getElementById('userEmailDisplay');

            const selectContador = document.getElementById('selectContador');
            const selectCliente = document.getElementById('selectCliente');
            const conceptosSelect = document.getElementById('conceptosSelect');
            const conceptoEditInput = document.getElementById('conceptoEditInput');

            // Asignar listeners a botones de login/registro
            if (registerBtn) {
                registerBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    authMessage.textContent = '';
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
                        console.log('Usuario registrado:', userCredential.user);
                        // No es necesario iniciar sesión manualmente, onAuthStateChanged lo detectará
                    } catch (error) {
                        console.error("Error en registro:", error.code, error.message);
                        authMessage.textContent = `Error: ${traducirErrorAuth(error.code)}`;
                    }
                });
            }

            if (loginBtn) {
                loginBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    authMessage.textContent = '';
                    try {
                        // Usar persistencia local
                        await setPersistence(auth, browserLocalPersistence);
                        const userCredential = await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
                        console.log('Usuario ha iniciado sesión:', userCredential.user);
                    } catch (error) {
                        console.error("Error en inicio de sesión:", error.code, error.message);
                        authMessage.textContent = `Error: ${traducirErrorAuth(error.code)}`;
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    signOut(auth).catch((error) => {
                        console.error("Error al cerrar sesión:", error);
                        showMessage("Error al cerrar sesión.", "error");
                    });
                });
            }
            
            // Observador del estado de autenticación (MOVIDO DENTRO DEL TRY)
            onAuthStateChanged(auth, (user) => {
                loadingOverlay.classList.add('hidden'); // Ocultar carga en cuanto sepa el estado
                if (user) {
                    // Usuario ha iniciado sesión
                    currentUserId = user.uid;
                    userEmailDisplay.textContent = user.email;
                    appContainer.classList.remove('hidden');
                    authContainer.classList.add('hidden');
                    
                    // Iniciar listeners de Firestore
                    loadDropdowns();
                    inicializarConceptos();

                } else {
                    // Usuario ha cerrado sesión o no está logueado
                    currentUserId = null;
                    appContainer.classList.add('hidden');
                    authContainer.classList.remove('hidden');
                    
                    // Limpiar datos y detener listeners
                    if (contadoresUnsubscribe) contadoresUnsubscribe();
                    if (clientesUnsubscribe) clientesUnsubscribe();
                    if (conceptosUnsubscribe) conceptosUnsubscribe();
                    
                    clearForm(); // Limpiar formulario
                    selectContador.innerHTML = '';
                    selectCliente.innerHTML = '';
                    conceptosSelect.innerHTML = '';
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            showMessage(error.message || "Error al conectar con la base de datos.", "error");
            
            // MOSTRAR LOGIN Y OCULTAR CARGA
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
            if (authContainer) authContainer.classList.remove('hidden');
            if (appContainer) appContainer.classList.add('hidden');
            if (authMessage) authMessage.textContent = error.message || "Error al conectar con la base de datos.";
        }


        // --- IDs de Elementos DOM ---
        /* (MOVIDOS ARRIBA)
        const authContainer = document.getElementById('auth-container');
        ...
        const conceptoEditInput = document.getElementById('conceptoEditInput');
        */
        
        // --- Lógica de Autenticación ---
        /* (MOVIDA ARRIBA)
        // Asignar listeners a botones de login/registro
        ...
        */

        // Observador del estado de autenticación (el controlador principal)
        /* (MOVIDO ARRIBA)
        onAuthStateChanged(auth, (user) => {
            ...
        });
        */

        // --- Lógica de Firestore (Reemplaza localStorage) ---

        function getCollectionPath(collectionName) {
            if (!currentUserId) {
                console.error("Usuario no autenticado. No se puede obtener la ruta.");
                return null;
            }
            // Ruta privada para cada usuario
            return `artifacts/${appId}/users/${currentUserId}/${collectionName}`;
        }

        // Traducir errores de Firebase Auth a español
        function traducirErrorAuth(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'El formato del correo electrónico no es válido.';
                case 'auth/user-not-found':
                    return 'No se encontró ningún usuario con este correo.';
                case 'auth/wrong-password':
                    return 'La contraseña es incorrecta.';
                case 'auth/email-already-in-use':
                    return 'Este correo electrónico ya está registrado.';
                case 'auth/weak-password':
                    return 'La contraseña debe tener al menos 6 caracteres.';
                case 'auth/operation-not-allowed':
                    return 'El inicio de sesión por correo y contraseña no está habilitado.';
                default:
                    return 'Ocurrió un error desconocido. Inténtalo de nuevo.';
            }
        }


        // --- Definición de Estilos de Botones ---
        const btnBaseClass = "py-2 px-3 text-sm font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        
        // Estilos de Botones de Gestión (Lila Claro)
        const btnIconBase = "p-2.5 font-semibold rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 inline-flex items-center justify-center";
        const btnIconLilac = `${btnIconBase} bg-purple-200 text-purple-800 hover:bg-purple-300 focus:ring-purple-400`;

        // Botón "Agregar Concepto" (Amarillo)
        const btnSecondaryClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        
        const btnPrimaryClass = "w-full py-3 px-6 bg-purple-700 text-white font-bold rounded-full shadow-lg hover:bg-purple-800 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95 flex items-center justify-center";
        
        // Botones de gestión ahora usan el estilo lila
        const btnDangerClass = btnIconLilac;
        const btnSaveClass = btnIconLilac;
        const btnWarningClass = btnIconLilac;

        // Botón Limpiar (Amarillo Claro) - Se quita w-full, se añade al div contenedor
        const btnClearClass = `${btnBaseClass} bg-yellow-200 text-yellow-800 hover:bg-yellow-300 focus:ring-yellow-300`;
        
        const btnSmallDangerClass = "p-1.5 bg-red-600 text-white rounded-full shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 transition-transform duration-150 ease-in-out active:scale-95";

        // --- Variables para el sello ---
        const contadorSelloInput = document.getElementById('contadorSello');
        const selloPreview = document.getElementById('selloPreview');

        // Asignar clases a los botones estáticos
        document.querySelector('.btn-secondary').className = btnSecondaryClass;
        document.querySelector('.btn-primary').className = btnPrimaryClass;
        document.getElementById('saveContadorBtn').className = btnSaveClass;
        document.getElementById('saveClienteBtn').className = btnSaveClass;
        document.getElementById('clearFormBtn').className = btnClearClass;
        document.getElementById('deleteContadorBtn').className = btnDangerClass + " gestion-btn";
        document.getElementById('updateContadorBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('deleteClienteBtn').className = btnDangerClass + " gestion-btn";
        document.getElementById('updateClienteBtn').className = btnWarningClass + " gestion-btn";
        document.getElementById('conceptoBtnAgregar').className = btnSaveClass;
        document.getElementById('conceptoBtnEditar').className = btnWarningClass;
        document.getElementById('conceptoBtnGuardarEdicion').className = `${btnSaveClass} hidden`; // Ocultar por defecto
        document.getElementById('conceptoBtnEliminar').className = btnDangerClass;

        // --- Event listener for seal preview ---
        contadorSelloInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file && file.type === "image/png") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selloPreview.src = e.target.result;
                    selloPreview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                selloPreview.src = '';
                selloPreview.classList.add('hidden');
                if (file) {
                    showMessage('Por favor, suba un archivo en formato PNG.', 'error');
                    contadorSelloInput.value = ''; // Limpiar input
                }
            }
        });

        // --- Funcionalidad de Persistencia de Datos (Dropdowns) ---
        // Almacenamiento local para los datos de los dropdowns (cache)
        let localContadores = [];
        let localClientes = [];
        let localConceptos = [];
        let edicionConceptoId = null; // Para saber qué ID se está editando

        function loadDropdowns() {
            if (!currentUserId) return;

            // Cargar Contadores
            const contadoresPath = getCollectionPath('contadores');
            if (contadoresPath) {
                contadoresUnsubscribe = onSnapshot(query(collection(db, contadoresPath)), (snapshot) => {
                    localContadores = []; // Reset cache local
                    selectContador.innerHTML = '<option value="">-- Selecciona Contador --</option>'; // Reset
                    snapshot.forEach((doc) => {
                        const cont = doc.data();
                        cont.id = doc.id; // Guardar el ID de Firestore
                        localContadores.push(cont);
                        
                        const option = document.createElement('option');
                        option.value = cont.id; // Usar ID de Firestore como value
                        option.textContent = `${cont.nombre} (CPC: ${cont.cpc})`;
                        selectContador.appendChild(option);
                    });
                    // Ocultar botones de gestión
                    document.getElementById('deleteContadorBtn').style.display = 'none';
                    document.getElementById('updateContadorBtn').style.display = 'none';
                }, (error) => console.error("Error al cargar contadores:", error));
            }

            // Cargar Clientes
            const clientesPath = getCollectionPath('clientes');
            if (clientesPath) {
                clientesUnsubscribe = onSnapshot(query(collection(db, clientesPath)), (snapshot) => {
                    localClientes = []; // Reset cache local
                    selectCliente.innerHTML = '<option value="">-- Selecciona Cliente --</option>'; // Reset
                    snapshot.forEach((doc) => {
                        const cli = doc.data();
                        cli.id = doc.id;
                        localClientes.push(cli);
                        
                        const option = document.createElement('option');
                        option.value = cli.id;
                        option.textContent = `${cli.nombre} (CI: ${cli.cedula})`;
                        selectCliente.appendChild(option);
                    });
                    // Ocultar botones de gestión
                    document.getElementById('deleteClienteBtn').style.display = 'none';
                    document.getElementById('updateClienteBtn').style.display = 'none';
                }, (error) => console.error("Error al cargar clientes:", error));
            }
        }

        function fillContadorForm(docId) {
            if (docId === "") {
                clearFormContador(false); // No limpiar el select
                return;
            }
            const cont = localContadores.find(c => c.id === docId);
            if (cont) {
                document.getElementById('contadorNombre').value = cont.nombre;
                document.getElementById('contadorRif').value = cont.rif;
                document.getElementById('contadorCpc').value = cont.cpc;
                // Mostrar botones de gestión
                document.getElementById('deleteContadorBtn').style.display = 'inline-block';
                document.getElementById('updateContadorBtn').style.display = 'inline-block';
            }
        }

        function fillClienteForm(docId) {
            if (docId === "") {
                clearFormCliente(false); // No limpiar el select
                return;
            }
            const cli = localClientes.find(c => c.id === docId);
            if (cli) {
                document.getElementById('clienteTratamiento').value = cli.tratamiento;
                document.getElementById('clienteNombre').value = cli.nombre;
                document.getElementById('clienteCedula').value = cli.cedula;
                // Mostrar botones de gestión
                document.getElementById('deleteClienteBtn').style.display = 'inline-block';
                document.getElementById('updateClienteBtn').style.display = 'inline-block';
            }
        }

        function getContadorForm() {
            const nombre = document.getElementById('contadorNombre').value;
            const rif = document.getElementById('contadorRif').value;
            const cpc = document.getElementById('contadorCpc').value;
            if (!nombre || !cpc) { // RIF ya no es obligatorio
                showMessage('Por favor, complete nombre y C.P.C. del contador.', 'error');
                return null;
            }
            return { nombre, rif, cpc, createdAt: serverTimestamp() }; // Añadir timestamp
        }

        function getClienteForm() {
            const tratamiento = document.getElementById('clienteTratamiento').value;
            const nombre = document.getElementById('clienteNombre').value;
            const cedula = document.getElementById('clienteCedula').value;
            if (!nombre || !cedula) {
                showMessage('Por favor, complete nombre y cédula del cliente.', 'error');
                return null;
            }
            return { tratamiento, nombre, cedula, createdAt: serverTimestamp() }; // Añadir timestamp
        }

        async function saveContador() {
            const cont = getContadorForm();
            if (!cont) return;
            
            // Verificar duplicados en cache local
            if (localContadores.some(c => c.cpc === cont.cpc)) {
                showMessage('Un contador con ese C.P.C. ya existe.', 'error');
                return;
            }
            
            const contadoresPath = getCollectionPath('contadores');
            if (!contadoresPath) return;

            try {
                await addDoc(collection(db, contadoresPath), cont);
                showMessage('Contador guardado con éxito.', 'success');
                clearFormContador(); // Limpiar formulario después de guardar
            } catch (error) {
                console.error("Error al guardar contador:", error);
                showMessage('Error al guardar contador.', 'error');
            }
        }
        
        async function updateContador() {
            const selectedDocId = selectContador.value;
            if (selectedDocId === "") return;
            
            const cont = getContadorForm();
            if (!cont) return;

            // Verificar si el CPC actualizado choca con *otro* existente
            const cpcExists = localContadores.some(c => c.cpc === cont.cpc && c.id !== selectedDocId);
            if (cpcExists) {
                showMessage('El C.P.C. actualizado ya pertenece a otro contador guardado.', 'error');
                return;
            }

            const contadorRef = doc(db, getCollectionPath('contadores'), selectedDocId);
            try {
                // Quitar createdAt para no sobreescribirlo, añadir updatedAt
                delete cont.createdAt; 
                cont.updatedAt = serverTimestamp();
                
                await updateDoc(contadorRef, cont);
                showMessage('Contador actualizado con éxito.', 'success');
            } catch (error) {
                console.error("Error al actualizar contador:", error);
                showMessage('Error al actualizar contador.', 'error');
            }
        }

        async function deleteContador() {
            const selectedDocId = selectContador.value;
            if (selectedDocId === "") return;
            
            // Usar un modal de confirmación en lugar de window.confirm
            showConfirmationModal('¿Está seguro de que desea eliminar este contador?', async () => {
                const contadorRef = doc(db, getCollectionPath('contadores'), selectedDocId);
                try {
                    await deleteDoc(contadorRef);
                    showMessage('Contador eliminado.', 'success');
                    clearFormContador(); // Limpia el formulario y resetea el select
                } catch (error) {
                    console.error("Error al eliminar contador:", error);
                    showMessage('Error al eliminar contador.', 'error');
                }
            });
        }

        async function saveCliente() {
            const cli = getClienteForm();
            if (!cli) return;

            if (localClientes.some(c => c.cedula === cli.cedula)) {
                 showMessage('Un cliente con esa Cédula ya existe.', 'error');
                 return;
            }
            
            const clientesPath = getCollectionPath('clientes');
            if (!clientesPath) return;

            try {
                await addDoc(collection(db, clientesPath), cli);
                showMessage('Cliente guardado con éxito.', 'success');
                clearFormCliente();
            } catch (error) {
                console.error("Error al guardar cliente:", error);
                showMessage('Error al guardar cliente.', 'error');
            }
        }
        
        async function updateCliente() {
            const selectedDocId = selectCliente.value;
            if (selectedDocId === "") return;

            const cli = getClienteForm();
            if (!cli) return;

            const cedulaExists = localClientes.some(c => c.cedula === cli.cedula && c.id !== selectedDocId);
            if (cedulaExists) {
                showMessage('La Cédula actualizada ya pertenece a otro cliente guardado.', 'error');
                return;
            }

            const clienteRef = doc(db, getCollectionPath('clientes'), selectedDocId);
            try {
                delete cli.createdAt;
                cli.updatedAt = serverTimestamp();
                await updateDoc(clienteRef, cli);
                showMessage('Cliente actualizado con éxito.', 'success');
            } catch (error) {
                console.error("Error al actualizar cliente:", error);
                showMessage('Error al actualizar cliente.', 'error');
            }
        }

        async function deleteCliente() {
            const selectedDocId = selectCliente.value;
            if (selectedDocId === "") return;

            showConfirmationModal('¿Está seguro de que desea eliminar este cliente?', async () => {
                const clienteRef = doc(db, getCollectionPath('clientes'), selectedDocId);
                try {
                    await deleteDoc(clienteRef);
                    showMessage('Cliente eliminado.', 'success');
                    clearFormCliente();
                } catch (error) {
                    console.error("Error al eliminar cliente:", error);
                    showMessage('Error al eliminar cliente.', 'error');
                }
            });
        }

        // --- Fin de Persistencia ---
        
        // --- Gestión de Conceptos de Ingreso (Firestore) ---
        
        async function inicializarConceptos() {
            if (!currentUserId) return;
            const conceptosPath = getCollectionPath('conceptos');
            if (!conceptosPath) return;

            // Verificar si los conceptos default ya existen
            const conceptosDefaultRef = doc(db, conceptosPath, 'defaults');
            const docSnap = await getDoc(conceptosDefaultRef);

            if (!docSnap.exists()) {
                // Si no existen, crearlos
                const conceptosDefault = [
                    "Actividades Comerciales",
                    "Director de la entidad",
                    "Docente contratado tiempo completo",
                    "Alquiler de inmueble",
                    "Venta de mercancías",
                    "Honorarios profesionales libre ejercicio",
                    "Honorarios Profesionales Médico",
                    "Honorarios Profesionales Médico Ginecólogo Obstetra"
                ];
                try {
                    // Usar un writeBatch para añadir los defaults
                    const batch = writeBatch(db);
                    conceptosDefault.forEach(concepto => {
                        const newConceptoRef = doc(collection(db, conceptosPath)); // ID automático
                        batch.set(newConceptoRef, { nombre: concepto, createdAt: serverTimestamp() });
                    });
                    // Añadir el documento 'defaults' para marcar que ya se hizo
                    batch.set(conceptosDefaultRef, { inicializado: true });
                    await batch.commit();
                    console.log("Conceptos por defecto inicializados.");
                } catch (error) {
                    console.error("Error inicializando conceptos default:", error);
                }
            }
            
            // Iniciar listener para cargar conceptos
            cargarConceptosUI();
        }

        function cargarConceptosUI() {
            const conceptosPath = getCollectionPath('conceptos');
            if (!conceptosPath) return;
            
            // Escuchar todos los conceptos excepto el 'defaults'
            const q = query(collection(db, conceptosPath), where('inicializado', '!=', true));
            
            conceptosUnsubscribe = onSnapshot(q, (snapshot) => {
                localConceptos = [];
                conceptosSelect.innerHTML = '';
                const datalist = document.getElementById('conceptos-list');
                datalist.innerHTML = '';

                snapshot.forEach((doc) => {
                    const concepto = doc.data();
                    concepto.id = doc.id;
                    localConceptos.push(concepto);
                    
                    // Cargar el <select> de gestión
                    const optionSelect = document.createElement('option');
                    optionSelect.value = concepto.id;
                    optionSelect.textContent = concepto.nombre;
                    conceptosSelect.appendChild(optionSelect);

                    // Cargar el <datalist> del formulario
                    const optionDataList = document.createElement('option');
                    optionDataList.value = concepto.nombre;
                    datalist.appendChild(optionDataList);
                });
                
                // Resetear estado de edición
                conceptoEditInput.value = '';
                conceptoBtnAgregar.style.display = 'inline-flex';
                conceptoBtnGuardarEdicion.style.display = 'none';
                edicionConceptoId = null;
            }, (error) => console.error("Error al cargar conceptos UI:", error));
        }

        conceptoBtnAgregar.addEventListener('click', async () => {
            const nuevoConceptoNombre = conceptoEditInput.value.trim();
            if (nuevoConceptoNombre) {
                if (localConceptos.some(c => c.nombre.toLowerCase() === nuevoConceptoNombre.toLowerCase())) {
                    showMessage('Ese concepto ya existe.', 'error');
                    return;
                }
                
                const conceptosPath = getCollectionPath('conceptos');
                if (!conceptosPath) return;
                
                try {
                    await addDoc(collection(db, conceptosPath), {
                        nombre: nuevoConceptoNombre,
                        createdAt: serverTimestamp()
                    });
                    showMessage('Concepto agregado.', 'success');
                    conceptoEditInput.value = ''; // Limpiar input
                } catch (error) {
                    console.error("Error agregando concepto:", error);
                    showMessage('Error al agregar concepto.', 'error');
                }
            }
        });

        conceptoBtnEditar.addEventListener('click', () => {
            const selectedId = conceptosSelect.value;
            const concepto = localConceptos.find(c => c.id === selectedId);
            if (concepto) {
                conceptoEditInput.value = concepto.nombre;
                edicionConceptoId = selectedId;
                conceptoBtnAgregar.style.display = 'none';
                conceptoBtnGuardarEdicion.style.display = 'inline-flex';
            } else {
                showMessage('Seleccione un concepto de la lista para editar.', 'error');
            }
        });

        conceptoBtnGuardarEdicion.addEventListener('click', async () => {
            const conceptoEditadoNombre = conceptoEditInput.value.trim();
            if (conceptoEditadoNombre && edicionConceptoId) {
                // Verificar duplicados (excluyendo el id actual)
                const duplicado = localConceptos.some(c => 
                    c.nombre.toLowerCase() === conceptoEditadoNombre.toLowerCase() && 
                    c.id !== edicionConceptoId
                );
                if (duplicado) {
                    showMessage('Ese concepto ya existe en la lista.', 'error');
                    return;
                }
                
                const conceptoRef = doc(db, getCollectionPath('conceptos'), edicionConceptoId);
                try {
                    await updateDoc(conceptoRef, {
                        nombre: conceptoEditadoNombre,
                        updatedAt: serverTimestamp()
                    });
                    showMessage('Concepto actualizado.', 'success');
                    // cargarConceptosUI() se encarga de resetear la UI
                } catch (error) {
                    console.error("Error actualizando concepto:", error);
                    showMessage('Error al actualizar concepto.', 'error');
                }
            }
        });

        conceptoBtnEliminar.addEventListener('click', () => {
            const selectedId = conceptosSelect.value;
            if (selectedId) {
                showConfirmationModal('¿Está seguro de que desea eliminar este concepto?', async () => {
                    const conceptoRef = doc(db, getCollectionPath('conceptos'), selectedId);
                    try {
                        await deleteDoc(conceptoRef);
                        showMessage('Concepto eliminado.', 'success');
                        // El listener onSnapshot actualizará la UI
                    } catch (error) {
                        console.error("Error eliminando concepto:", error);
                        showMessage('Error al eliminar concepto.', 'error');
                    }
                });
            } else {
                showMessage('Seleccione un concepto de la lista para eliminar.', 'error');
            }
        });

        // --- Fin Gestión Conceptos ---

        // --- Limpiar Formulario ---
        function clearFormContador(limpiarSelect = true) {
            document.getElementById('contadorNombre').value = '';
            document.getElementById('contadorRif').value = '';
            document.getElementById('contadorCpc').value = '';
            contadorSelloInput.value = ''; // Limpiar el input de archivo
            selloPreview.src = ''; // Limpiar la previsualización
            selloPreview.classList.add('hidden'); // Ocultar previsualización
            if (limpiarSelect) selectContador.value = "";
            document.getElementById('deleteContadorBtn').style.display = 'none';
            document.getElementById('updateContadorBtn').style.display = 'none';
        }
        
        function clearFormCliente(limpiarSelect = true) {
            document.getElementById('clienteTratamiento').value = 'Sr.';
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteCedula').value = '';
            if (limpiarSelect) selectCliente.value = "";
            document.getElementById('deleteClienteBtn').style.display = 'none';
            document.getElementById('updateClienteBtn').style.display = 'none';
        }

        function clearForm() {
            document.getElementById('report-form').reset();
            document.getElementById('income-details').innerHTML = '';
            addIncomeItem();
            clearFormContador();
            clearFormCliente();
            setFechasDefault(); // Restablecer fechas
            showMessage('Formulario limpiado.', 'success');
        }
        document.getElementById('clearFormBtn').addEventListener('click', clearForm);
        // --- Fin Limpiar Formulario ---

        // --- Modal de Confirmación (Reemplazo de window.confirm) ---
        function showConfirmationModal(message, onConfirm) {
            // Crear el fondo oscuro
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50';
            
            // Crear el modal
            const modal = document.createElement('div');
            modal.className = 'bg-white p-6 rounded-lg shadow-xl max-w-sm w-full';
            
            // Mensaje
            const msg = document.createElement('p');
            msg.className = 'text-gray-800 mb-4';
            msg.textContent = message;
            modal.appendChild(msg);
            
            // Contenedor de botones
            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex justify-end gap-4';
            
            // Botón Cancelar
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-full shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.onclick = () => document.body.removeChild(overlay);
            
            // Botón Confirmar
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'py-2 px-4 bg-red-600 text-white font-semibold rounded-full shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500';
            confirmBtn.textContent = 'Eliminar';
            confirmBtn.onclick = () => {
                onConfirm(); // Ejecutar la acción de eliminación
                document.body.removeChild(overlay);
            };
            
            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(confirmBtn);
            modal.appendChild(btnContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // --- Formato Automático Cédula y RIF ---
        
        function formatCedula(e) {
            let input = e.target.value.replace(/[^a-zA-Z0-9]/g, ''); // Limpiar
            let letter = (input.match(/^[VEve]/) || ['V'])[0].toUpperCase(); // Default V
            let numbers = input.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, ''); // Solo números

            if (numbers.length > 8) {
                numbers = numbers.substring(0, 8); // Max 8 números
            }
            
            // Formato con puntos dinámico (más simple)
            let formattedNumbers = numbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

            e.target.value = `${letter}-${formattedNumbers}`;
        }
        
        function formatRif(e) {
            let input = e.target.value.replace(/[^a-zA-Z0-9]/g, ''); // Limpiar
            let letter = (input.match(/^[JGjgVEvePp]/) || ['V'])[0].toUpperCase(); // Default V
            let numbers = input.replace(/^[VEveJjGgPp]/, '').replace(/\D/g, ''); // Solo números
            
            let mainNumbers = numbers;
            let digit = '';

            if (numbers.length > 8) {
                digit = numbers.substring(numbers.length - 1);
                mainNumbers = numbers.substring(0, 8); // Max 8 para el cuerpo
            }

            // Formato con puntos
            let formattedMain = mainNumbers.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            e.target.value = `${letter}-${formattedMain}${digit ? '-' + digit : ''}`;
        }

        document.getElementById('clienteCedula').addEventListener('input', formatCedula);
        document.getElementById('contadorRif').addEventListener('input', formatRif);

        // --- Formato de Miles ---
        function formatSimpleThousands(e) {
            let val = e.target.value.replace(/[^\d]/g, '');
            if (!val) {
                e.target.value = '';
                return;
            }
            let num = parseInt(val, 10);
            e.target.value = new Intl.NumberFormat('es-VE').format(num);
        }

        function formatCurrencyInput(e) {
            let val = e.target.value.replace(/[^\d,]/g, ''); // Permitir solo dígitos y comas
            let parts = val.split(',');
            
            let intPart = parts[0].replace(/\./g, ''); // Quitar puntos de miles viejos
            if (intPart) {
                let num = parseInt(intPart, 10);
                if (isNaN(num)) {
                    intPart = '';
                } else {
                    intPart = new Intl.NumberFormat('es-VE').format(num);
                }
            } else if (parts.length > 1) { // Si empieza con coma, ej: ",50"
                 intPart = '0';
            } else {
                intPart = '';
            }

            let decPart = parts[1];
            if (decPart !== undefined) {
                e.target.value = intPart + ',' + decPart.substring(0, 2);
            } else {
                e.target.value = intPart;
            }
        }

        function parseFormattedNumber(strVal) {
            if (!strVal) return 0;
            return strVal.replace(/\./g, '').replace(',', '.');
        }
        
        document.getElementById('contadorCpc').addEventListener('input', formatSimpleThousands);
        // --- Fin Formato Automático ---

        // --- Setear Fechas Default ---
        function setFechasDefault() {
            const now = new Date();
            
            const today = now.toISOString().split('T')[0];
            document.getElementById('fechaDocumento').value = today;

            const year = now.getFullYear();
            const month = now.getMonth(); // Mes actual (0-11)
            
            const firstDay = new Date(year, month, 1).toISOString().split('T')[0];
            const lastDay = new Date(year, month + 1, 0).toISOString().split('T')[0];
            
            document.getElementById('fechaDesde').value = firstDay;
            document.getElementById('fechaHasta').value = lastDay;
        }
        // --- Fin Fechas Default ---

        // Event Listeners para guardado y carga
        document.addEventListener('DOMContentLoaded', () => {
            // La carga de datos ahora se dispara por onAuthStateChanged
            addIncomeItem(); // Agregar un item de ingreso por defecto
            setFechasDefault(); // Establecer fechas
        });
        selectContador.addEventListener('change', (e) => fillContadorForm(e.target.value));
        selectCliente.addEventListener('change', (e) => fillClienteForm(e.target.value));
        document.getElementById('saveContadorBtn').addEventListener('click', saveContador);
        document.getElementById('updateContadorBtn').addEventListener('click', updateContador);
        document.getElementById('deleteContadorBtn').addEventListener('click', deleteContador);
        document.getElementById('saveClienteBtn').addEventListener('click', saveCliente);
        document.getElementById('updateClienteBtn').addEventListener('click', updateCliente);
        document.getElementById('deleteClienteBtn').addEventListener('click', deleteCliente);
        
        // --- Resto del Script (Sin cambios) ---

        // Función para mostrar mensajes
        /* (MOVIDA ARRIBA)
        function showMessage(message, type = 'success') {
            ...
        }
        */

        // Función para agregar campos de ingreso
        function addIncomeItem() {
            const container = document.getElementById('income-details');
            const itemDiv = document.createElement('div');
            // --- MODIFICACIÓN VISTA MÓVIL ---
            // flex-col en móvil, md:flex-row en desktop. gap-3.
            itemDiv.className = 'flex flex-col md:flex-row items-center gap-3 income-item';
            
            const conceptInput = document.createElement('input');
            conceptInput.type = 'text';
            conceptInput.placeholder = 'Concepto (Ej: Honorarios profesionales)';
            // w-full en móvil, md:flex-grow en desktop
            conceptInput.className = 'w-full md:flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-concept';
            conceptInput.setAttribute('list', 'conceptos-list');
            conceptInput.required = true;
            
            const amountInput = document.createElement('input');
            amountInput.type = 'text'; // Cambiado a text para formato
            amountInput.inputMode = 'decimal'; // Teclado numérico en móviles
            amountInput.placeholder = 'Monto (Bs.)';
            // w-full en móvil, md:w-32 en desktop
            amountInput.className = 'w-full md:w-32 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500 income-amount';
            amountInput.required = true;
            amountInput.addEventListener('input', formatCurrencyInput); // Agregar listener de formato

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = btnSmallDangerClass; // Usar clase más pequeña
             // w-full en móvil, md:w-auto en desktop
            removeBtn.classList.add('w-full', 'md:w-auto');
            removeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> <span class="md:hidden ml-2">Eliminar Concepto</span>'; // Texto para móvil
            removeBtn.onclick = function() {
                // Solo remover si hay más de un item
                if (container.querySelectorAll('.income-item').length > 1) {
                    container.removeChild(itemDiv);
                } else {
                    showMessage('Debe haber al menos un concepto de ingreso.', 'error');
                }
            };
            
            itemDiv.appendChild(conceptInput);
            itemDiv.appendChild(amountInput);
            itemDiv.appendChild(removeBtn);
            container.appendChild(itemDiv);
        }

        // Función para formatear fechas
        function formatDate(dateString, options = {}) {
            if (!dateString) return '';
            const { format = 'dd/mm/yyyy' } = options;
            const date = new Date(dateString + 'T00:00:00'); // Asumir zona horaria local
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            if (format === 'dd de M de yyyy') {
                const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
                return `${day} de ${monthNames[date.getMonth()]} ${year}`;
            }
            return `${day}/${month}/${year}`;
        }
        
        // Función para formatear números como moneda
        function formatCurrency(number) {
            return new Intl.NumberFormat('es-VE', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(number);
        }

        // Función para calcular la diferencia de meses
        function calculateMonths(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let months = (end.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += end.getMonth();
            
            if (end.getDate() < start.getDate()) {
                months--;
            }
            return months <= 0 ? 1 : months + 1; // +1 para incluir ambos meses
        }

        // Manejador del formulario (Modificado para leer sello)
        document.getElementById('report-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const incomeItems = document.querySelectorAll('.income-item');
            if (incomeItems.length === 0) {
                showMessage('Debe agregar al menos un concepto de ingreso.', 'error');
                return;
            }
            let valid = true;
            incomeItems.forEach(item => {
                const concept = item.querySelector('.income-concept').value;
                const amount = item.querySelector('.income-amount').value;
                // Validar que el monto no sea solo "0" o vacío
                if (!concept || !amount || parseFloat(parseFormattedNumber(amount)) <= 0) {
                    valid = false;
                }
            });

            if (!valid) {
                showMessage('Revise los conceptos de ingreso. No pueden estar vacíos o en cero.', 'error');
                return;
            }

            // --- Lógica de Lectura de Sello ---
            const selloFile = contadorSelloInput.files[0];

            if (selloFile) {
                if (selloFile.type !== "image/png") {
                    showMessage('El sello debe ser un archivo PNG.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Creamos una imagen en memoria para leer sus dimensiones
                        const img = new Image();
                        img.onload = function() {
                            const originalWidth = this.width;
                            const originalHeight = this.height;
                            buildPDF(e.target.result, originalWidth, originalHeight); // Pasar dimensiones
                        };
                        img.src = e.target.result; // dataURL Base64
                        
                        // El mensaje de éxito se muestra dentro de buildPDF si todo sale bien
                    } catch (error) {
                        console.error("Error al generar PDF con sello:", error);
                        showMessage('Hubo un error al generar el PDF.', 'error');
                    }
                };
                reader.onerror = function() {
                     console.error("Error al leer el archivo del sello.");
                     showMessage('Hubo un error al leer la imagen del sello.', 'error');
                }
                reader.readAsDataURL(selloFile);

            } else {
                // Generar PDF sin sello
                try {
                    buildPDF(null, 0, 0); // Llamar sin dataURL ni dimensiones
                } catch (error) {
                    console.error("Error al generar PDF:", error);
                    showMessage('Hubo un error al generar el PDF.', 'error');
                }
            }
        });

        // --- Función principal para generar el PDF (Renombrada a buildPDF) ---
        function buildPDF(sealDataUrl, originalSealWidth, originalSealHeight) { // <--- Parámetros añadidos
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter'); // Tamaño carta

            // --- 1. Recolectar Datos ---
            const contadorNombre = document.getElementById('contadorNombre').value;
            const contadorCpc = document.getElementById('contadorCpc').value;
            const contadorRif = document.getElementById('contadorRif').value; 
            const clienteTratamiento = document.getElementById('clienteTratamiento').value;
            const clienteNombre = document.getElementById('clienteNombre').value;
            const clienteCedula = document.getElementById('clienteCedula').value;
            const entidadDirigida = document.getElementById('entidadDirigida').value;
            const motivoInforme = document.getElementById('motivoInforme').value;
            const lugar = document.getElementById('lugar').value;
            const fechaDocumentoRaw = document.getElementById('fechaDocumento').value;
            const fechaDesdeRaw = document.getElementById('fechaDesde').value;
            const fechaHastaRaw = document.getElementById('fechaHasta').value;

            // Formatear fechas
            const fechaDocumentoLarga = `${lugar}, ${formatDate(fechaDocumentoRaw, { format: 'dd de M de yyyy' })}`;
            const fechaDesde = formatDate(fechaDesdeRaw);
            const fechaHasta = formatDate(fechaHastaRaw);
            const fechaDesdeLarga = formatDate(fechaDesdeRaw, { format: 'dd de M de yyyy' });
            const fechaHastaLarga = formatDate(fechaHastaRaw, { format: 'dd de M de yyyy' });
            
            // Recolectar ingresos
            const incomeItems = document.querySelectorAll('.income-item');
            let totalIngresos = 0;
            const tableData = [];
            incomeItems.forEach(item => {
                const concept = item.querySelector('.income-concept').value;
                const amountStr = item.querySelector('.income-amount').value;
                const amount = parseFloat(parseFormattedNumber(amountStr)) || 0;
                
                if (concept && amount > 0) {
                    tableData.push([concept, `Bs. ${formatCurrency(amount)}`]);
                    totalIngresos += amount;
                }
            });

            // Calcular promedio mensual
            const numMeses = calculateMonths(fechaDesdeRaw, fechaHastaRaw);
            const promedioMensual = totalIngresos / numMeses;

            // --- 2. Definir Variables y Estilos del PDF ---
            
            // Márgenes en puntos (1 cm = 28.35 pt)
            const marginTop = 5 * 28.35; // 5cm
            const marginBottom = 3 * 28.35; // 3cm
            const marginLeft = 60;
            const marginRight = 60;
            const pageHeight = doc.internal.pageSize.getHeight();
            const usableWidth = doc.internal.pageSize.getWidth() - marginLeft - marginRight;
            let currentY = marginTop; // Posición Y inicial

            doc.setFont('helvetica', 'normal');

            // Función helper para agregar texto (MODIFICADA)
            function addText(text, options = {}) {
                const {
                    fontSize = 11, // Tamaño base 11pt
                    fontStyle = 'normal',
                    align = 'justify', // Justificado por defecto
                    indent = 0,
                    spacing = 15,
                    lineSpacing = 1.5 // (Interlineado)
                } = options;
                
                doc.setFontSize(fontSize);
                doc.setFont('helvetica', fontStyle);
                
                let x;
                const maxWidth = usableWidth - indent;

                if (align === 'center') {
                    x = doc.internal.pageSize.getWidth() / 2;
                } else if (align === 'right') {
                    x = doc.internal.pageSize.getWidth() - marginRight;
                } else {
                    x = marginLeft + indent;
                }

                // Calculamos la altura del bloque de texto
                const lines = doc.splitTextToSize(text, maxWidth);
                // Ajuste de cálculo de altura para mayor precisión
                const textHeight = (lines.length * fontSize * lineSpacing) - (fontSize * (lineSpacing - 1));
                
                // Comprobar si cabe en la página actual
                if (currentY + textHeight > pageHeight - marginBottom) {
                    doc.addPage();
                    currentY = marginTop; // Margen superior en nueva página
                }

                // Dibujar el texto
                doc.text(text, x, currentY, { 
                    align: align, 
                    maxWidth: maxWidth,
                    lineHeightFactor: lineSpacing // Factor de interlineado
                });
                
                // Actualizar currentY
                currentY += textHeight + spacing;
            }

            // --- 3. Construir el PDF (Página 1) ---
            
            addText('INFORME DE ENCARGOS DE ASEGURAMIENTO DEL CONTADOR PÚBLICO INDEPENDIENTE', { fontSize: 11, fontStyle: 'bold', align: 'center', spacing: 30 }); 
            addText('Alcance', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText(`He revisado la evidencia inherente a los ingresos percibidos por el ${clienteTratamiento} ${clienteNombre}, con cedula de identidad N.º ${clienteCedula}, durante el periodo comprendido desde el ${fechaDesde} hasta el ${fechaHasta}, presentado en la relación de ingresos adjunta, correspondiente a su actividad económica según se detalla en el anexo.`, { indent: 20, spacing: 25 });
            addText('Responsabilidad de la persona que percibe los ingresos', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText(`El ${clienteTratamiento} ${clienteNombre}, es responsable de la preparación y presentación del importe de sus ingresos que se adjunta en este informe, incluyendo la integridad, legalidad y veracidad de los documentos suministrados. Esta responsabilidad incluye la aseveración de que todos y cada uno de los ingresos detallados en la relación, provienen de actividades legítimas y de comprobable licito ejercicio.`, { indent: 20, spacing: 25 });
            addText('Responsabilidad del Contador Público Independiente', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText(`Mi responsabilidad es expresar una opinión sobre la relación de ingresos obtenida por el ${clienteTratamiento} ${clienteNombre}, durante el periodo señalado de acuerdo con mis procedimientos, los cuales he realizado de conformidad con la Norma Internacional para encargos de aseguramiento, los cuales he realizado de conformidad con la Normas Internacionales de Encargos de Aseguramiento NIEA 3000, esta norma prevé que cumpla con los requerimientos éticos y que planifique y realice los procedimientos para obtener una seguridad razonable de que, en todos los aspectos materiales, la relación está presentada razonablemente.`, { indent: 20, spacing: 15 });
            addText(`Un Encargo de Aseguramiento implica llevar a cabo procedimientos para obtener evidencia acerca de la razonabilidad de las aseveraciones emitidas por el responsable. Los procedimientos seleccionados dependen del juicio profesional del contador público, que incluye evaluar los riesgos acerca de que los ingresos no estén presentados razonablemente. El objetivo es obtener una seguridad razonable como base de una forma positiva de expresión. Por lo tanto, mi responsabilidad es expresar una opinión sobre los ingresos del ${clienteTratamiento} ${clienteNombre}, para el periodo ${fechaDesde} hasta el ${fechaHasta}, con base al examen sobre la evidencia obtenida.`, { indent: 20, spacing: 25 });

            // --- Forzar Página 2 ---
            doc.addPage();
            currentY = marginTop; // Reiniciar Y en la nueva página

            // --- Construir el PDF (Página 2) ---
            addText('Identificación del criterio de evaluación', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText(`Mi trabajo consistió, en examinar los estados de cuenta de bancos, declaraciones de impuesto, contratos, entre otros documentos inherentes, comprobar y confirmar los ingresos relacionados por el ${clienteTratamiento} ${clienteNombre}, para el periodo señalado. Mi opinión se formó sobre la base de la evidencia obtenida suficiente y adecuada. El criterio utilizado para emitirla fue la definición de ingresos contenida en la sección 2, conceptos y principios generales, de las normas internacionales de información financiera para las pequeñas y medianas entidades aun cuando no le son aplicables a personas naturales no comerciantes.`, { indent: 20, spacing: 25 });
            addText('Opinión', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText('Con base en el trabajo efectuado descrito en este informe, no ha llamado mi atención algo que me haga pensar que la relación de ingresos que se anexa, en todos los aspectos importantes, no sea razonable y que los ingresos detallados en la relación, no provenga de actividades legítimas y de comprobable lícito ejercicio.', { indent: 20, spacing: 25 });
            addText('Usuarios Previstos y Propósitos', { fontSize: 11, fontStyle: 'bold', align: 'left', spacing: 20 });
            addText(`Este informe y la relación que se adjunta están dirigidos únicamente al ${entidadDirigida} el cual lo ha requerido para ${motivoInforme}.`, { indent: 20, spacing: 40 });


            // --- Firma del Contador (al final de la página) ---
            
            // 1. Definir parámetros de la firma
            const fontSize = 11;
            const lineSpacing = 1.0; // Interlineado simple para la firma
            const spacing = 12; // Espacio entre líneas (original, para espacio con fecha)
            
            // **** MODIFICACIÓN: Interlineado de la firma a 12pt (igual que cliente) ****
            const spacingFirma = 12; // Interlineado de 12 ptos solicitado por el usuario

            // 2. Función interna para calcular la altura de un bloque de texto
            const calcHeight = (text, ls = lineSpacing) => {
                const lines = doc.splitTextToSize(text, usableWidth); // Asumir usableWidth para centrado
                const h = (lines.length * fontSize * ls) - (fontSize * (ls - 1));
                return h;
            };

            // 3. Calcular la altura de CADA línea de la firma
            const h1 = calcHeight('________________________________');
            const h2 = calcHeight(`${contadorNombre}`);
            const h3 = calcHeight(`Rif: ${contadorRif}`);
            const h4 = calcHeight(`Contador Público C.P.C. N ${contadorCpc}`); 
            const h5 = calcHeight(fechaDocumentoLarga, 1.5); // La fecha usa interlineado 1.5

            // 4. Calcular la altura total del bloque (**** USANDO spacingFirma ****)
            // Ajustar altura si el RIF está vacío
            let signatureBlockHeight = h1 + spacingFirma + h2 + spacingFirma + h4;
            if (contadorRif) {
                signatureBlockHeight += spacingFirma + h3;
            }
            
            const dateHeight = h5;
            
            // 5. Calcular Y de la firma (usando 'spacing' original para separar de la fecha)
            const sigBlockY = pageHeight - marginBottom - dateHeight - (spacing * 2) - signatureBlockHeight;

            // --- *** MODIFICACIÓN: Agregar Sello del Contador *** ---
            if (sealDataUrl && originalSealWidth > 0 && originalSealHeight > 0) {
                
                // **** MODIFICACIÓN: Tamaño 5.30cm x 2.10cm ****
                const cm = 28.35; // Puntos por cm
                const maxSealWidth = 5.30 * cm;  // 150.005 pt
                const maxSealHeight = 2.10 * cm; // 59.535 pt

                // Convertir dimensiones originales (px) a puntos (asumiendo 72 ppi para la conversión interna de jsPDF)
                // Nota: jsPDF addImage maneja la escala, pero calculamos la proporción nosotros mismos para asegurar.
                
                let sealWidth = originalSealWidth;
                let sealHeight = originalSealHeight;
                
                // Calcular ratios
                const widthRatio = maxSealWidth / sealWidth;
                const heightRatio = maxSealHeight / sealHeight;
                
                // Usar el ratio MÁS PEQUEÑO para escalar y mantener la proporción
                const ratio = Math.min(widthRatio, heightRatio); 
                
                sealWidth = sealWidth * ratio;
                sealHeight = sealHeight * ratio;

                // Si la imagen es más pequeña que el máximo, no la agrandamos
                if (originalSealWidth < maxSealWidth && originalSealHeight < maxSealHeight) {
                    sealWidth = originalSealWidth;
                    sealHeight = originalSealHeight;
                }

                // Posición X (Derecha)
                const sealX = doc.internal.pageSize.getWidth() - marginRight - sealWidth;
                
                // --- AJUSTE DE POSICIÓN Y ---
                // Posición Y (Alineada justo encima de la línea de la firma, con un pequeño espacio)
                const sealY = sigBlockY - sealHeight - (spacing / 2); // Subir el sello un poco

                // Comprobar si cabe
                if (sealY > marginTop && sealY + sealHeight <= pageHeight - marginBottom) {
                    // Agregar la imagen del sello
                    doc.addImage(sealDataUrl, 'PNG', sealX, sealY, sealWidth, sealHeight);
                } else {
                     // Si no cabe (improbable), ponerlo en el margen superior
                     doc.addImage(sealDataUrl, 'PNG', sealX, marginTop, sealWidth, sealHeight);
                }
            }
            // --- *** FIN DEL BLOQUE DEL SELLO *** ---
            
            // ----- RE-CÁLCULO DE FIRMA -----
            // Posicionar la fecha al final
            currentY = pageHeight - marginBottom - dateHeight;
            addText(fechaDocumentoLarga, { align: 'left', spacing: 0, fontSize: 11, lineSpacing: 1.5 }); // Dibujar fecha al final, alineada izquierda

            // Posicionar la firma justo encima de la fecha
            // Usamos 'spacing' (12) para el espacio entre la fecha y el bloque
            currentY = pageHeight - marginBottom - dateHeight - (spacing * 2) - signatureBlockHeight;
            
            // **** MODIFICACIÓN: 'spacing' cambiado a spacingFirma (12) y orden/estilo de firma ****
            addText('________________________________', { align: 'center', spacing: spacingFirma, fontSize: 11, lineSpacing: lineSpacing });
            addText(`${contadorNombre}`, { align: 'center', spacing: spacingFirma, fontSize: 11, fontStyle: 'bold', lineSpacing: lineSpacing });
            addText(`Contador Público C.P.C. N ${contadorCpc}`, { align: 'center', spacing: spacingFirma, fontSize: 11, lineSpacing: lineSpacing });
            // Solo mostrar RIF si se ingresó
            if (contadorRif) {
                addText(`Rif: ${contadorRif}`, { align: 'center', spacing: spacingFirma, fontSize: 11, lineSpacing: lineSpacing }); 
            }
            
            // --- Forzar Página 3 (Anexo) ---
            doc.addPage();
            currentY = marginTop;

            // --- Construir el PDF (Página 3 - Anexo) ---
            
            addText(`${clienteNombre.toUpperCase()}`, { fontSize: 11, fontStyle: 'bold', align: 'center', spacing: 10, lineSpacing: 1.5 });
            addText(`${clienteCedula}`, { fontSize: 11, fontStyle: 'bold', align: 'center', spacing: 30, lineSpacing: 1.5 });
            addText(`INGRESOS MENSUALES EXPRESADO EN BOLÍVARES (BS)`, { fontSize: 11, fontStyle: 'bold', align: 'center', spacing: 20, lineSpacing: 1.5 });
            addText(`Los ingresos corresponden al período desde el ${fechaDesdeLarga} hasta el ${fechaHastaLarga} y los mismos se derivan de:`, { fontSize: 11, align: 'justify', spacing: 30, lineSpacing: 1.5 });
            
            doc.autoTable({
                head: [['Detalle de los ingresos del periodo:', 'Bolívares']],
                body: tableData,
                // --- AJUSTE DE ALINEACIÓN DEL FOOTER ---
                // Se definen las celdas como objetos para forzar sus estilos individuales
                foot: [
                    [
                        { content: 'Total Ingresos', styles: { halign: 'left' } },
                        { content: `Bs. ${formatCurrency(totalIngresos)}`, styles: { halign: 'right' } }
                    ]
                ],
                startY: currentY,
                margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
                theme: 'grid',
                headStyles: { 
                    fillColor: [221, 214, 254], 
                    textColor: [31, 41, 55], 
                    fontStyle: 'bold', 
                    halign: 'center', 
                    fontSize: 11, 
                    font: 'helvetica',
                    lineColor: [209, 213, 219], 
                    lineWidth: 0.5
                },
                footStyles: { 
                    fillColor: [243, 244, 246], 
                    textColor: [0, 0, 0], 
                    fontStyle: 'bold', 
                    fontSize: 11, 
                    font: 'helvetica',
                    lineColor: [209, 213, 219],
                    lineWidth: 0.5
                },
                bodyStyles: { 
                    font: 'helvetica', 
                    fontSize: 11,
                    lineColor: [209, 213, 219],
                    lineWidth: 0.5
                },
                columnStyles: {
                    0: { halign: 'left' },
                    1: { halign: 'right' },
                },
                didDrawPage: (data) => {
                    // Si autoTable crea una nueva página, resetear currentY
                    if (data.pageNumber > 3) {
                        currentY = marginTop;
                    } else {
                        currentY = data.cursor.y;
                    }
                }
            });

            currentY = doc.autoTable.previous.finalY + 30; // Actualizar Y después de la tabla

            // --- Control de página para la firma del cliente ---
            // Calcular altura de la firma del cliente
            const hLegitimacion = calcHeight('LEGITIMACION DE CAPITALES', 1.5) + 15 + calcHeight('Los ingresos descritos...', 1.5) + 50;
            const hFirmaCliente = calcHeight('_____________________________________', 1.0) + 12 + calcHeight(`${clienteNombre}`, 1.0) + 12 + calcHeight(`C.I. ${clienteCedula}`, 1.0);
            const totalHeightFirma = hLegitimacion + hFirmaCliente;

            if (currentY + totalHeightFirma > pageHeight - marginBottom) {
                doc.addPage();
                currentY = marginTop;
            }
            
            // Sección de Legitimación
            addText('LEGITIMACION DE CAPITALES', { fontSize: 11, fontStyle: 'bold', align: 'center', spacing: 15, lineSpacing: 1.5 });
            addText('Los ingresos descritos en la presente relación proceden de actividad lícita, lo cual puede ser corroborado por los organismos competentes y no tienen relación alguna con actividades, acciones o hechos ilícitos contemplados en las leyes venezolanas.', { fontSize: 11, align: 'justify', spacing: 50, lineSpacing: 1.5 });
            
            // --- Firma del Cliente (al final de la página) ---
            // Recalcular Y por si acaso
            const signatureHeightCliente = hFirmaCliente;
            
            let finalY = pageHeight - marginBottom - signatureHeightCliente;
            
            // Si el texto anterior + la firma no caben, se usa el final de la página
            if (currentY > finalY) { 
                currentY = finalY;
            } else {
                // Si hay mucho espacio, bajar la firma
                 currentY = Math.max(currentY, finalY);
            }
            
            addText('_____________________________________', { align: 'center', spacing: 12, fontSize: 11, lineSpacing: 1.0 });
            addText(`${clienteNombre}`, { align: 'center', spacing: 12, fontSize: 11, fontStyle: 'bold', lineSpacing: 1.0 });
            addText(`C.I. ${clienteCedula}`, { align: 'center', spacing: 12, fontSize: 11, lineSpacing: 1.0 });

            // --- 4. Guardar el PDF ---
            doc.save(`Informe_Aseguramiento_${clienteNombre.replace(/\s/g, '_')}.pdf`);
            showMessage('PDF generado con éxito.', 'success'); // Mensaje de éxito
        }
    </script>

</body>
</html>